<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binary Nixie Watch</title>
    <meta name="description" content="A beautiful binary clock with vintage Nixie tube aesthetics">
    <link rel="stylesheet" href="./src/css/styles.css">
    <!-- Load D3 immediately - it doesn't create AudioContext -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <!-- DON'T load Tone.js here - we'll load it lazily after user interaction -->
</head>
<body>
<div class="background-glow"></div>
<div class="startup-overlay" id="startup">
    <div class="startup-text">INITIALIZING BINARY CHRONOMETER...</div>
</div>

<button class="sound-toggle" id="soundToggle">
    <div class="sound-icon">üîá</div>
    <span>SOUND</span>
</button>

<div class="scene">
    <div class="watch-container" id="watchContainer">
        <div class="watch-base">
            <div class="time-display" id="timeDisplay">--:--:--</div>

            <div class="binary-section">
                <div class="section-label">Hours</div>
                <svg id="hoursSvg" width="300" height="100"></svg>
            </div>

            <div class="binary-section">
                <div class="section-label">Minutes</div>
                <svg id="minutesSvg" width="360" height="100"></svg>
            </div>

            <div class="binary-section">
                <div class="section-label">Seconds</div>
                <svg id="secondsSvg" width="360" height="100"></svg>
            </div>
        </div>
    </div>
</div>

<script type="module">
  let d3Loaded = false;
  let toneLoaded = false;
  let toneLoadingPromise = null;
  let watchInitialized = false;

  // Function to dynamically load Tone.js
  function loadToneJS() {
    if (toneLoadingPromise) return toneLoadingPromise;

    toneLoadingPromise = new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js';
      script.onload = () => {
        toneLoaded = true;
        // Make Tone available globally
        window.Tone = Tone;
        resolve();
      };
      script.onerror = () => {
        console.error('‚ùå Failed to load Tone.js');
        reject(new Error('Failed to load Tone.js'));
      };
      document.head.appendChild(script);
    });

    return toneLoadingPromise;
  }

  // Make the Tone loader available globally so AudioManager can use it
  window.loadToneJS = loadToneJS;

  // Function to initialize the watch (without audio initially)
  async function initializeWatchWithoutAudio() {
    if (watchInitialized) return;

    try {
      const [{ SVGDefinitions }, { AudioManager }, { BinaryNixieWatch }] = await Promise.all([
        import('./src/js/svg-definitions.js'),
        import('./src/js/audio-manager.js'),
        import('./src/js/nixie-watch.js')
      ]);

      // Make classes available globally
      window.SVGDefinitions = SVGDefinitions;
      window.AudioManager = AudioManager;
      window.BinaryNixieWatch = BinaryNixieWatch;

      // Initialize the watch
      window.nixieWatch = new BinaryNixieWatch();
      watchInitialized = true;
    } catch (error) {
      document.getElementById('startup').innerHTML =
        '<div class="startup-text">Loading Error - Please Refresh</div>';
    }
  }

  // Check when D3 loads
  function checkD3() {
    if (typeof d3 !== 'undefined') {
      d3Loaded = true;
      initializeWatchWithoutAudio();
    } else {
      setTimeout(checkD3, 50);
    }
  }

  // Set up early user interaction detection for audio
  function setupAudioInteractionDetection() {
    const handleFirstInteraction = async () => {
      // Remove listeners after first interaction
      document.removeEventListener('click', handleFirstInteraction);
      document.removeEventListener('keydown', handleFirstInteraction);
      document.removeEventListener('touchstart', handleFirstInteraction);
    };

    document.addEventListener('click', handleFirstInteraction);
    document.addEventListener('keydown', handleFirstInteraction);
    document.addEventListener('touchstart', handleFirstInteraction);
  }

  // Start the initialization process
  window.addEventListener('load', () => {
    setupAudioInteractionDetection();
    checkD3();
  });
</script>
</body>
</html>